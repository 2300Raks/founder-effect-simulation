<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Founder Effect Simulation</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body {
      font-family: sans-serif;
      background: #e0f7fa;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
    }
    .controls {
      text-align: center;
      margin: 10px;
    }
    label {
      display: inline-block;
      margin: 5px;
      font-size: 14px;
    }
    input[type=range] {
      width: 150px;
    }
    button {
      margin: 5px;
      padding: 8px 15px;
      font-size: 16px;
      border: none;
      border-radius: 5px;
      background: #0077b6;
      color: white;
      cursor: pointer;
    }
    canvas {
      border: 2px solid #0077b6;
      margin-top: 10px;
    }
    #graph {
      width: 90%;
      max-width: 800px;
      margin: 20px auto;
    }
  </style>
</head>
<body>
  <div class="controls" id="controlPanel" style="display: none;">
    <button onclick="toggleSimulation()"><span id="toggleText">Pause</span> Simulation</button>
    <button onclick="resetSimulation()">Reset Simulation</button>
    <br>
    <label>Predator Intensity: <input type="range" id="predatorSlider" min="0" max="10" value="0"></label>
    <label>Food Scarcity: <input type="range" id="foodSlider" min="0" max="10" value="0"></label>
  </div>

  <div id="sketch-holder"></div>
  <div id="graph">
    <canvas id="populationChart"></canvas>
  </div>

  <script>
    let seals = [], foxes = [], hunters = [], bullets = [];
    let introScreen = true;
    let running = true;
    let generation = 0;
    let sealHistory = [], foxHistory = [];
    const initialPopulation = 6000;
    const finalFounderPop = 20;
    const sealSize = 8;
    const predatorUnit = 2;
    const sealsPerDot = 20;
    const generationDelay = 7000;
    let phase = 'bottleneck';
    let survivorTrait = null;
    let lastUpdateTime = 0;
    let sealsToKillThisGen = 1000;
    let sealsKilledSoFar = 0;
    let killRatePerFrame = 20;

    function getPredatorIntensity() {
      return parseInt(document.getElementById('predatorSlider').value);
    }
    function getFoodScarcity() {
      return parseInt(document.getElementById('foodSlider').value);
    }

    function setup() {
      let canvas = createCanvas(800, 400);
      canvas.parent('sketch-holder');
      for (let i = 0; i < initialPopulation; i++) {
        seals.push(new Seal());
      }
      for (let i = 0; i < 5; i++) {
        hunters.push(new Hunter());
      }
      frameRate(30);
    }

    function draw() {
      if (introScreen) {
        drawIntroScreen();
        return;
      }
      drawBackground();
      drawLegend();

      if (phase === 'bottleneck') {
        runBottleneck();
      } else {
        drawSimulation();
        if (millis() - lastUpdateTime >= generationDelay && running) {
          updateGeneration();
          lastUpdateTime = millis();
        }
      }
    }

    function drawIntroScreen() {
      background(30, 60, 100);
      fill(255);
      textAlign(CENTER, CENTER);
      textSize(32);
      text("Founder Effect Simulation", width / 2, 100);
      textSize(18);
      text("Watch how a population bottleneck caused by human hunting", width / 2, 170);
      text("leads to genetic drift in Northern Elephant Seals.", width / 2, 200);
      text("Observe natural selection, predator impact, and food depletion", width / 2, 230);
      text("as the population evolves over generations.", width / 2, 260);

      fill(0, 180, 255);
      rect(width / 2 - 80, 300, 160, 40, 10);
      fill(255);
      textSize(20);
      text("Start Simulation", width / 2, 320);
    }

    function mousePressed() {
      if (introScreen && mouseX > width / 2 - 80 && mouseX < width / 2 + 80 && mouseY > 300 && mouseY < 340) {
        introScreen = false;
      }
    }

    function drawBackground() {
      background(180, 220, 250);
      noStroke();
      fill(100, 180, 100);
      rect(0, height - 80, width, 80);
    }

    function drawLegend() {
      fill(255, 255, 255, 180);
      rect(600, 10, 190, 160, 10);
      fill(0);
      textSize(12);
      text("Legend:", 610, 25);
      fill(100, 150, 200);
      ellipse(625, 45, 10);
      fill(0);
      text("= 20 Seals", 640, 50);
      fill(200, 50, 50);
      triangle(625, 70, 618, 80, 632, 80);
      fill(0);
      text("= 2 Predators", 640, 80);
      fill(255, 0, 0);
      text("X = Killed Seal", 610, 100);
      fill(0);
      rect(625, 120, 20, 10);
      rect(632, 110, 6, 10);
      text("= Hunter", 650, 130);
      stroke(0);
      line(625, 150, 625, 158);
      noStroke();
      text("= Bullet", 640, 158);
    }

    function drawSimulation() {
      fill(255, 255, 255, 180);
      noStroke();
      rect(10, 10, 200, 130, 10);
      fill(0);
      textSize(14);
      textAlign(LEFT);
      text(`Generation: ${generation}`, 20, 30);
      text(`Seal Pop: ${seals.length}`, 20, 50);
      text(`Foxes: ${foxes.length * predatorUnit}`, 20, 70);
      text(`Predator Intensity: ${getPredatorIntensity()}`, 20, 90);
      text(`Food Scarcity: ${getFoodScarcity()}`, 20, 110);
      for (let i = 0; i < Math.min(seals.length / sealsPerDot, seals.length); i++) {
        seals[i].display();
      }
      for (let fox of foxes) {
        fox.display();
      }
    }

    function runBottleneck() {
      fill(0);
      textSize(16);
      text(`Founder Effect: Hunters Killing Seals`, 20, 30);
      text(`Remaining Seals: ${seals.length}`, 20, 60);
      text(`Generation: ${generation}`, 20, 90);
      for (let hunter of hunters) {
        hunter.move();
        hunter.display();
        hunter.fire();
      }
      for (let i = bullets.length - 1; i >= 0; i--) {
        let b = bullets[i];
        b.move();
        b.display();
        for (let j = seals.length - 1; j >= 0; j--) {
          let s = seals[j];
          if (dist(b.x, b.y, s.x, s.y) < 8) {
            showDeadSeal(s.x, s.y);
            seals.splice(j, 1);
            bullets.splice(i, 1);
            sealsKilledSoFar++;
            break;
          }
        }
        if (i < bullets.length && b.offscreen()) {
          bullets.splice(i, 1);
        }
      }
      if (seals.length > finalFounderPop && sealsKilledSoFar < sealsToKillThisGen) {
        let deaths = Math.min(killRatePerFrame, seals.length - finalFounderPop, sealsToKillThisGen - sealsKilledSoFar);
        for (let i = 0; i < deaths; i++) {
          const victim = Math.floor(Math.random() * seals.length);
          showDeadSeal(seals[victim].x, seals[victim].y);
          seals.splice(victim, 1);
          sealsKilledSoFar++;
        }
      }
      if (sealsKilledSoFar >= sealsToKillThisGen) {
        sealHistory.push({ x: generation++, y: seals.length });
        updateChart();
        sealsKilledSoFar = 0;
      }
      for (let seal of seals) {
        seal.display();
      }
      if (seals.length <= finalFounderPop) {
        if (!survivorTrait && seals.length > 0) {
          survivorTrait = seals[0].trait;
        }
        seals = seals.filter(s => Math.abs(s.trait - survivorTrait) < 0.01);
        while (seals.length < finalFounderPop) {
          seals.push(new Seal(survivorTrait));
        }
        bullets = [];
        phase = 'simulation';
        lastUpdateTime = millis();
        document.getElementById('controlPanel').style.display = 'block';
      }
    }

    function updateGeneration() {
      let predatorIntensity = getPredatorIntensity();
      let foodScarcity = getFoodScarcity();
      if (predatorIntensity > 0) {
        let expectedFoxes = Math.floor((seals.length / 50) * (predatorIntensity / 10));
        while (foxes.length < expectedFoxes) foxes.push(new Fox());
        while (foxes.length > expectedFoxes) foxes.pop();
      } else {
        foxes = [];
      }
      if (foodScarcity > 0) {
        let scarcityFactor = 1 - (foodScarcity / 15);
        seals = seals.filter(() => Math.random() < scarcityFactor);
      }
      for (let fox of foxes) {
        fox.move();
        fox.hunt(seals);
      }
      for (let seal of seals) seal.move();
      let newSeals = [];
      for (let seal of seals) {
        if (Math.random() < 0.4) {
          newSeals.push(new Seal(seal.trait));
        }
      }
      seals = seals.concat(newSeals);
      if (seals.length > 4000) {
        seals = seals.slice(0, 4000);
      }
      generation++;
      sealHistory.push({ x: generation, y: seals.length });
      foxHistory.push({ x: generation, y: foxes.length * predatorUnit });
      if (sealHistory.length > 100) {
        sealHistory.shift();
        foxHistory.shift();
      }
      updateChart();
    }

    class Seal {
      constructor(trait) {
        this.x = Math.random() * width;
        this.y = Math.random() * 80 + height - 100;
        this.trait = trait !== undefined ? trait : Math.random();
        this.color = color(50 + this.trait * 180, 100, 150);
      }
      move() {
        this.x += Math.random() * 4 - 2;
        this.y += Math.random() * 2 - 1;
        this.x = constrain(this.x, 0, width);
        this.y = constrain(this.y, height - 100, height - 20);
      }
      display() {
        fill(this.color);
        noStroke();
        ellipse(this.x, this.y, sealSize);
      }
    }

    class Fox {
      constructor() {
        this.x = Math.random() * width;
        this.y = Math.random() * 80 + height - 100;
        this.speed = 2;
      }
      move() {
        this.x += Math.random() * 2 * this.speed - this.speed;
        this.y += Math.random() * 2 * this.speed - this.speed;
        this.x = constrain(this.x, 0, width);
        this.y = constrain(this.y, height - 100, height - 20);
      }
      hunt(seals) {
        for (let i = seals.length - 1; i >= 0; i--) {
          let s = seals[i];
          if (dist(this.x, this.y, s.x, s.y) < 10 && Math.random() < 0.3) {
            seals.splice(i, 1);
            break;
          }
        }
      }
      display() {
        fill(200, 50, 50);
        triangle(this.x, this.y, this.x - 8, this.y + 8, this.x + 8, this.y + 8);
      }
    }

    class Hunter {
      constructor() {
        this.x = Math.random() * width;
        this.y = Math.random() * 70 + 10;
        this.speed = 1.2;
      }
      move() {
        this.x += Math.random() * 2 * this.speed - this.speed;
        this.x = constrain(this.x, 0, width);
      }
      display() {
        fill(0);
        rect(this.x - 10, this.y, 20, 10);
        rect(this.x - 3, this.y - 10, 6, 10);
      }
      fire() {
        if (Math.random() < 0.03) {
          bullets.push(new Bullet(this.x, this.y + 10));
        }
      }
    }

    class Bullet {
      constructor(x, y) {
        this.x = x;
        this.y = y;
        this.speed = 5;
      }
      move() {
        this.y += this.speed;
      }
      display() {
        stroke(0);
        strokeWeight(2);
        line(this.x, this.y, this.x, this.y + 8);
      }
      offscreen() {
        return this.y > height;
      }
    }

    function showDeadSeal(x, y) {
      push();
      stroke(255, 0, 0);
      strokeWeight(2);
      line(x - 6, y - 6, x + 6, y + 6);
      line(x + 6, y - 6, x - 6, y + 6);
      pop();
    }

    function toggleSimulation() {
      running = !running;
      document.getElementById('toggleText').innerText = running ? 'Pause' : 'Start';
    }

    function resetSimulation() {
      location.reload();
    }

    let ctx = document.getElementById('populationChart').getContext('2d');
    let populationChart = new Chart(ctx, {
      type: 'line',
      data: {
        datasets: [
          {
            label: 'Seal Population',
            borderColor: '#0077b6',
            backgroundColor: '#90e0ef',
            data: [],
          },
          {
            label: 'Fox Population',
            borderColor: '#d00000',
            backgroundColor: '#ffb3b3',
            data: [],
          }
        ]
      },
      options: {
        scales: {
          x: {
            title: { display: true, text: 'Generation' },
            type: 'linear',
            position: 'bottom',
          },
          y: {
            title: { display: true, text: 'Population' },
            beginAtZero: true
          }
        }
      }
    });

    function updateChart() {
      populationChart.data.datasets[0].data = sealHistory;
      populationChart.data.datasets[1].data = foxHistory;
      populationChart.update();
    }
  </script>
</body>
</html>



